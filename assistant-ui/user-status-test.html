<!DOCTYPE html>
<html>
<head>
    <title>User Status Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>User Status Test</h1>
    
    <div class="test-section">
        <h3>1. ç™»å½•æµ‹è¯•</h3>
        <button onclick="testLogin()">ç™»å½• (admin/admin123)</button>
        <div id="loginResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</h3>
        <button onclick="checkAuthStatus()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
        <button onclick="getUserDetails()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
        <div id="statusResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. ç™»å‡ºæµ‹è¯•</h3>
        <button onclick="showLogoutDialog()">ç™»å‡º (ä½¿ç”¨HTMLå¯¹è¯æ¡†)</button>
        <div id="logoutResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. è·³è½¬åˆ°åº”ç”¨</h3>
        <button onclick="goToApp()">æ‰“å¼€ä¸»åº”ç”¨</button>
    </div>

    <!-- ç™»å‡ºç¡®è®¤å¯¹è¯æ¡† -->
    <div id="logoutDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000;" onclick="hideLogoutDialog()">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 400px; width: 90%; border: 1px solid #e5e7eb;" onclick="event.stopPropagation()">
            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                <div style="width: 40px; height: 40px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                    <span style="font-size: 18px;">ğŸšª</span>
                </div>
                <h3 style="margin: 0; color: #111827; font-size: 18px; font-weight: 600;">ç¡®è®¤ç™»å‡º</h3>
            </div>
            <p style="margin: 0 0 24px 0; color: #6b7280; line-height: 1.6; font-size: 14px;">æ‚¨ç¡®å®šè¦ç™»å‡ºå½“å‰è´¦æˆ·å—ï¼Ÿç™»å‡ºåæ‚¨éœ€è¦é‡æ–°ç™»å½•æ‰èƒ½ç»§ç»­ä½¿ç”¨åº”ç”¨ã€‚</p>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="hideLogoutDialog()" style="padding: 10px 16px; border: 1px solid #d1d5db; background: white; cursor: pointer; border-radius: 8px; transition: all 0.2s; font-weight: 500; color: #374151; font-size: 14px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">å–æ¶ˆ</button>
                <button onclick="confirmLogout()" style="padding: 10px 16px; border: 1px solid #dc2626; background: transparent; color: #dc2626; cursor: pointer; border-radius: 8px; transition: all 0.2s; font-weight: 500; font-size: 14px;" onmouseover="this.style.background='#dc2626'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='#dc2626'">ç¡®è®¤ç™»å‡º</button>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿè®¤è¯å·¥å…·å‡½æ•°
        const getToken = () => localStorage.getItem("token");
        
        const setToken = (token) => {
            localStorage.setItem("token", token);
            window.dispatchEvent(new CustomEvent('tokenChanged'));
        };
        
        const removeToken = () => {
            localStorage.removeItem("token");
            window.dispatchEvent(new CustomEvent('tokenChanged'));
        };
        
        const isAuthenticated = () => {
            const token = getToken();
            if (!token) return false;
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const currentTime = Math.floor(Date.now() / 1000);
                return payload.exp > currentTime;
            } catch (error) {
                console.warn('Invalid token format:', error);
                removeToken();
                return false;
            }
        };
        
        const getUserInfo = () => {
            const token = getToken();
            if (!token) return null;
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return {
                    id: payload.sub,
                    username: payload.username,
                };
            } catch (error) {
                console.warn('Failed to parse user info from token:', error);
                return null;
            }
        };

        async function testLogin() {
            const result = document.getElementById('loginResult');
            try {
                const response = await fetch('http://localhost:8000/api/users/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                const data = await response.json();
                
                if (data.access_token) {
                    setToken(data.access_token);
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>ç™»å½•æˆåŠŸ!</strong><br>
                        Token: ${data.access_token.substring(0, 50)}...<br>
                        User: ${data.user.username} (${data.user.display_name})
                    `;
                } else {
                    throw new Error('No access token received');
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `<strong>ç™»å½•å¤±è´¥:</strong> ${error.message}`;
            }
        }

        function checkAuthStatus() {
            const result = document.getElementById('statusResult');
            const authenticated = isAuthenticated();
            const token = getToken();
            
            result.className = authenticated ? 'result success' : 'result error';
            result.innerHTML = `
                <strong>è®¤è¯çŠ¶æ€:</strong> ${authenticated ? 'å·²ç™»å½•' : 'æœªç™»å½•'}<br>
                <strong>Tokenå­˜åœ¨:</strong> ${token ? 'Yes' : 'No'}<br>
                ${token ? `<strong>Token:</strong> ${token.substring(0, 50)}...` : ''}
            `;
        }

        function getUserDetails() {
            const result = document.getElementById('statusResult');
            const userInfo = getUserInfo();
            
            if (userInfo) {
                result.className = 'result success';
                result.innerHTML = `
                    <strong>ç”¨æˆ·ä¿¡æ¯:</strong><br>
                    ID: ${userInfo.id}<br>
                    Username: ${userInfo.username}
                `;
            } else {
                result.className = 'result error';
                result.innerHTML = '<strong>æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯</strong>';
            }
        }

        function testLogout() {
            const result = document.getElementById('logoutResult');
            removeToken();
            result.className = 'result success';
            result.innerHTML = '<strong>å·²ç™»å‡º</strong> - Tokenå·²æ¸…é™¤ï¼ŒtokenChangedäº‹ä»¶å·²è§¦å‘';
        }

        function showLogoutDialog() {
            document.getElementById('logoutDialog').style.display = 'block';
        }

        function hideLogoutDialog() {
            document.getElementById('logoutDialog').style.display = 'none';
        }

        function confirmLogout() {
            const result = document.getElementById('logoutResult');
            removeToken();
            result.className = 'result success';
            result.innerHTML = '<strong>å·²ç™»å‡º</strong> - ä½¿ç”¨HTMLå¯¹è¯æ¡†ç¡®è®¤ï¼ŒTokenå·²æ¸…é™¤ï¼ŒtokenChangedäº‹ä»¶å·²è§¦å‘';
            hideLogoutDialog();
        }

        function goToApp() {
            window.open('http://localhost:5173', '_blank');
        }

        // ç›‘å¬tokenChangedäº‹ä»¶
        window.addEventListener('tokenChanged', () => {
            console.log('Token changed event received!');
        });

        // ç›‘å¬ESCé”®å…³é—­å¯¹è¯æ¡†
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                hideLogoutDialog();
            }
        });
    </script>
</body>
</html>
